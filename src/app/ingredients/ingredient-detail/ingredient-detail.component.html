<main class="detail-wrapper ingredient-detail-wrapper" role="main">
  <!-- Loading / Error -->
  <div *ngIf="loading" class="loading-message glass-card" role="status">
    <mat-icon
      class="loading-icon"
      svgIcon="hourglass_empty"
      aria-hidden="true"
    ></mat-icon>
    <p>Loading ingredient details...</p>
  </div>

  <div *ngIf="error" class="error-message glass-card" role="alert">
    <mat-icon color="warn" svgIcon="error" aria-hidden="true"></mat-icon>
    <span>{{ error }}</span>
    <button
      class="glass-button secondary"
      (click)="goBack()"
      aria-label="Go back to previous page"
    >
      <mat-icon svgIcon="arrow_back" aria-hidden="true"></mat-icon> Go Back
    </button>
  </div>

  <!-- Main content -->
  <article
    *ngIf="!loading && ingredient"
    class="ingredient-detail-grid"
    aria-labelledby="ingredient-title"
  >
    <!-- Header principale -->
    <header class="main-ingredient-header glass-card" role="region">
      <div class="header-content">
        <div
          class="ingredient-main-image-wrapper"
          role="figure"
          [attr.aria-label]="'Photo of ' + ingredient.name"
        >
          <img
            class="ingredient-image-circular"
            [ngSrc]="getPreferred(getIngredientHeroUrl(ingredient))"
            [alt]="
              ingredient.name
                ? 'Photo of ' + ingredient.name
                : 'Ingredient image'
            "
            width="100"
            height="100"
            priority
            decoding="async"
            [attr.sizes]="'100px'"
            fetchpriority="high"
            (error)="onImgError($event, getIngredientHeroUrl(ingredient))"
          />
        </div>

        <div>
          <h1
            id="ingredient-title"
            class="ingredient-title justify-left"
            [attr.aria-label]="'Ingredient: ' + ingredient.name"
          >
            {{ ingredient.name }}
          </h1>

          <h2
            class="ingredient-subtitle"
            [attr.aria-label]="
              'Ingredient summary for ' +
              ingredient.name +
              ', ' +
              (ingredient.isAlcoholic ? 'Alcoholic' : 'Non-Alcoholic') +
              (ingredient.ingredient_type
                ? ', type ' + ingredient.ingredient_type
                : '')
            "
          >
            {{ ingredient.isAlcoholic ? "Alcoholic" : "Non-Alcoholic" }}
            <span
              *ngIf="
                ingredient?.ai_alcohol_content &&
                ingredient.ai_alcohol_content !== 'Non-alcoholic'
              "
            >
              (<ng-container
                *ngIf="
                  +('' + ingredient.ai_alcohol_content).replace('%', '') !== 0
                "
                >~</ng-container
              >{{ ingredient.ai_alcohol_content | formatAbv }})
            </span>

            <span
              *ngIf="ingredient.ingredient_type"
              class="ml-2 px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full inline-block"
            >
              {{ ingredient.ingredient_type }}
            </span>
          </h2>

          <p class="ingredient-description">
            {{
              ingredient.description_from_cocktaildb ||
                ingredient.ai_flavor_profile ||
                ingredient.ai_common_uses
            }}
          </p>
        </div>
      </div>
    </header>

    <!-- TOP AD -->
    <section
      class="ad-block"
      [ngClass]="adSlotClass(topBannerType)"
      role="complementary"
      aria-labelledby="ad-top"
    >
      <span id="ad-top" class="ad-badge">Ad</span>
      @defer (when contentReady; on viewport) {
      <div class="ad-slot-inner">
        <app-dev-ads [type]="topBannerType"></app-dev-ads>
      </div>
      } @placeholder {
      <div class="ad-slot-placeholder" aria-hidden="true"></div>
      }
    </section>

    <!-- AI Insights -->
    <section
      class="ai-insights-section glass-card dark"
      role="region"
      [attr.aria-labelledby]="'insights-' + ingredient.slug"
    >
      <h2 id="insights-{{ ingredient.slug }}" class="section-title">
        ✨ In-depth Details of {{ ingredient.name }}
      </h2>

      <ng-container *ngIf="aiReady; else aiSkeleton">
        <div class="ai-blocks-grid">
          <div
            class="ai-detail-block glass-card-mini"
            *ngIf="ingredient.ai_flavor_profile"
            role="group"
          >
            <h3 class="ai-block-title">👅 Flavor Profile</h3>
            <p>{{ ingredient.ai_flavor_profile }}</p>
          </div>

          <div
            class="ai-detail-block glass-card-mini"
            *ngIf="ingredient.ai_common_uses"
            role="group"
          >
            <h3 class="ai-block-title">🥂 Common Uses</h3>
            <p>{{ ingredient.ai_common_uses }}</p>
          </div>

          <div
            class="ai-detail-block glass-card-mini"
            *ngIf="ingredient.ai_substitutes"
            role="group"
          >
            <h3 class="ai-block-title">🔄 Substitutes</h3>
            <p>{{ ingredient.ai_substitutes }}</p>
          </div>

          <div
            class="ai-detail-block glass-card-mini"
            *ngIf="ingredient.ai_brief_history"
            role="group"
          >
            <h3 class="ai-block-title">📜 Brief History</h3>
            <p>{{ ingredient.ai_brief_history }}</p>
          </div>

          <div
            class="ai-detail-block glass-card-mini"
            *ngIf="ingredient.ai_interesting_facts"
            role="group"
          >
            <h3 class="ai-block-title">💡 Interesting Facts</h3>
            <p>{{ ingredient.ai_interesting_facts }}</p>
          </div>
        </div>
      </ng-container>

      <ng-template #aiSkeleton>
        <div class="ai-blocks-grid ai-skeleton" aria-hidden="true">
          <div class="ai-detail-block glass-card-mini">
            <div class="sk-title"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>
          <div class="ai-detail-block glass-card-mini">
            <div class="sk-title"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>
          <div class="ai-detail-block glass-card-mini">
            <div class="sk-title"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>
          <div class="ai-detail-block glass-card-mini">
            <div class="sk-title"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>
          <div class="ai-detail-block glass-card-mini">
            <div class="sk-title"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>
        </div>
      </ng-template>
    </section>

    <!-- SECOND AD -->
    <section
      class="ad-block"
      [ngClass]="adSlotClass(topBannerType)"
      role="complementary"
      aria-labelledby="ad-second"
    >
      <span id="ad-second" class="ad-badge">Ad</span>
      @defer (when contentReady; on viewport) {
      <div class="ad-slot-inner">
        <app-dev-ads [type]="topBannerType"></app-dev-ads>
      </div>
      } @placeholder {
      <div class="ad-slot-placeholder" aria-hidden="true"></div>
      }
    </section>

    <!-- Related Cocktails -->
    <section
      class="related-cocktails-section glass-card dark"
      role="region"
      [attr.aria-labelledby]="'related-' + ingredient.slug"
    >
      <h2 id="related-{{ ingredient.slug }}" class="section-title">
        ✨ Cocktails using {{ ingredient.name }}
      </h2>

      <div
        *ngIf="
          ingredient.relatedCocktails && ingredient.relatedCocktails.length > 0
        "
        class="cards-grid limit-4"
      >
        <ng-container
          *ngFor="
            let item of cocktailItems;
            let i = index;
            trackBy: trackCocktailOrAd
          "
        >
          <ng-container *ngIf="isCocktailItem(item); else adBlock">
            <app-cocktail-card
              [cocktail]="item"
              [routerLink]="['/cocktails', item.slug]"
              [isLcp]="
                item.slug === firstRelatedCocktailSlug ||
                item.id === firstRelatedCocktailId
              "
              [priorityIngredientName]="ingredient.name"
            ></app-cocktail-card>
          </ng-container>

          <!-- BLOCCO AD NEL LOOP -->
          <ng-template #adBlock>
            <div
              class="cocktail-card ad-card"
              [ngClass]="adSlotClass(gridAdType)"
              role="complementary"
              aria-labelledby="'ad-loop-' + i"
            >
              <span
                [attr.id]="'ad-loop-' + i"
                class="ad-badge"
                aria-hidden="false"
                >Ad</span
              >
              @defer (when contentReady; on viewport) {
              <app-dev-ads [type]="gridAdType"></app-dev-ads>
              } @placeholder {
              <div
                class="ad-slot-placeholder"
                [ngClass]="adSlotClass(gridAdType)"
                aria-hidden="true"
              ></div>
              }
            </div>
          </ng-template>
        </ng-container>
      </div>

      <p
        *ngIf="
          !ingredient.relatedCocktails ||
          ingredient.relatedCocktails.length === 0
        "
        class="no-related-cocktails"
        role="note"
      >
        🤷‍♂️ No cocktails found that use this ingredient.
      </p>
    </section>
  </article>

  <!-- Navigation -->
  <nav
    class="navigation-bar"
    *ngIf="!loading && !error"
    aria-label="Ingredient navigation"
  >
    <div class="nav-top">
      <a
        *ngIf="previousIngredient"
        [routerLink]="['/ingredients', previousIngredient.slug]"
        class="glass-button secondary nav-button"
        [attr.aria-label]="
          'Previous ingredient: ' + (previousIngredient.name || '')
        "
      >
        <mat-icon svgIcon="chevron_left" aria-hidden="true"></mat-icon>
        <div class="ingredient-image-wrapper-nav" aria-hidden="true">
          <img
            [src]="previousIngredient.imageUrl"
            alt=""
            class="nav-ingredient-image"
            width="36"
            height="36"
            loading="lazy"
            decoding="async"
          />
        </div>
        {{ previousIngredient.name }}
      </a>

      <a
        *ngIf="nextIngredient"
        [routerLink]="['/ingredients', nextIngredient.slug]"
        class="glass-button secondary nav-button"
        [attr.aria-label]="'Next ingredient: ' + (nextIngredient.name || '')"
      >
        {{ nextIngredient.name }}
        <div class="ingredient-image-wrapper-nav" aria-hidden="true">
          <img
            [src]="nextIngredient.imageUrl"
            alt=""
            class="nav-ingredient-image"
            width="36"
            height="36"
            loading="lazy"
            decoding="async"
          />
        </div>
        <mat-icon svgIcon="chevron_right" aria-hidden="true"></mat-icon>
      </a>
    </div>

    <div class="nav-bottom">
      <button
        class="glass-button secondary"
        (click)="goBack()"
        aria-label="Go back to ingredient list"
      >
        <mat-icon svgIcon="arrow_back" aria-hidden="true"></mat-icon>
        <span>Go Back</span>
      </button>
    </div>
  </nav>

  <!-- Bottom banner -->
  <section
    class="ad-block"
    [ngClass]="adSlotClass(topBannerType)"
    role="complementary"
    aria-labelledby="ad-bottom"
  >
    <span id="ad-bottom" class="ad-badge">Ad</span>
    @defer (when contentReady; on viewport) {
    <div class="ad-slot-inner">
      <app-dev-ads [type]="topBannerType"></app-dev-ads>
    </div>
    } @placeholder {
    <div class="ad-slot-placeholder" aria-hidden="true"></div>
    }
  </section>
</main>
