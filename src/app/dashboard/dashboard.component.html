<div class="dashboard-container">
  <div *ngIf="loading" class="loading-message">
    <p>Loading dashboard data‚Ä¶</p>
  </div>

  <div *ngIf="error" class="error-message">
    <span class="icon-inline" aria-hidden="true">‚ö†Ô∏è</span>
    <p>{{ error }}</p>
    <button class="glass-button primary" (click)="ngOnInit()">Retry</button>
  </div>

  <div *ngIf="!loading && !error" class="dashboard-content">
    <!-- CAROUSEL -->
    <section
      #carouselRoot
      class="carousel glass-card hero bg-dots"
      role="region"
      aria-roledescription="carousel"
      aria-label="Featured content"
      tabindex="0"
      [style.--slides]="slidesCount"
      (mouseenter)="pauseCarousel()"
      (mouseleave)="resumeCarousel()"
      (focusin)="pauseCarousel()"
      (focusout)="resumeCarousel()"
      (keydown)="onCarouselKeydown($event)"
      (touchstart)="onTouchStart($event)"
      (touchend)="onTouchEnd($event)"
    >
      <div class="carousel-viewport">
        <div
          class="carousel-track"
          [style.width.%]="slidesCount * 100"
          [style.transform]="
            'translateX(-' + (100 / slidesCount) * currentSlide + '%)'
          "
          [style.transition]="isAnimating ? 'transform 500ms ease' : 'none'"
        >
          <!-- Slide 1 -->
          <article class="slide">
            <div class="slide-content slide1">
              <app-logo [size]="'lg'"></app-logo>
              <h2 class="hero-subtitle first">
                Discover cocktail recipes<br />mixology tips<br />ingredient
                guides
              </h2>
              <p class="hero-line">
                Shake it, stir it, make it yours ‚Äî cocktails made simple.
                <br />
                Explore recipes, learn ingredients, and level up your home bar
                with Fizzando.
              </p>
            </div>
          </article>

          <!-- Slide 2 -->
          <article class="slide">
            <div class="slide-content">
              <h2 class="hero-subtitle">
                Discover Hundreds of Cocktail Recipes
              </h2>
              <div class="emoticon">üçπ</div>
              <p class="hero-line2">
                EXPLORE COCKTAIL RECIPES FROM CLASSIC TO MODERN CREATIONS
              </p>
              <p class="hero-line">
                Find drinks by spirit, style, or occasion ‚Äî with clear
                instructions and pro techniques.
              </p>

              <button
                class="btn-shine hover-move"
                [routerLink]="['/cocktails']"
              >
                <span class="icon-button">üçπ</span>
                <span>Cocktails Explorer</span>
              </button>
            </div>
          </article>

          <!-- Slide 3 -->
          <article class="slide">
            <div class="slide-content">
              <h2 class="hero-subtitle">
                Learn the Ingredients Behind Great Cocktails
              </h2>
              <div class="emoticon em-slide3">
                <span>üçã</span> üçæ <span>üçç</span>
              </div>
              <p class="hero-line2">
                DISCOVER SPIRITS, LIQUEURS AND MIXERS BEHIND EVERY GREAT
                COCKTAIL
              </p>
              <p class="hero-line">
                Learn origins, flavor profiles, and smart substitutions for your
                home bar
              </p>

              <button
                class="btn-shine hover-move"
                [routerLink]="['/ingredients']"
              >
                <span class="icon-button">üåø</span>
                <span>Ingredients Explorer</span>
              </button>
            </div>
          </article>

          <!-- Slide 4 -->
          <article class="slide">
            <div class="slide-content">
              <h2 class="hero-subtitle">Make Cocktails With What You Have</h2>
              <div class="emoticon em-slide4">
                üçì <span> + </span> üåø <span> + </span> üçæ <span> = </span>
                <span class="result"> üçπ </span>
              </div>
              <p class="hero-line2">
                TURN YOUR HOME INGREDIENTS INTO GREAT COCKTAILS
              </p>
              <p class="hero-line">
                Choose your available ingredients and discover drinks ready to
                make at home
              </p>
              <button
                class="glass-button secondary"
                [routerLink]="['/find-cocktail']"
              >
                Find Your Cocktail
                <span class="icon-inline" aria-hidden="true">üëÅÔ∏è</span>
              </button>
            </div>
          </article>
        </div>
      </div>
      <!-- Progress (tempo rimasto) -->
      <div class="carousel-progress" *ngIf="autoplayMs > 0" aria-hidden="true">
        <div class="bar" [style.width.%]="progressPct"></div>
      </div>
      <!-- Controls -->
      <button
        class="carousel-btn prev"
        type="button"
        (click)="prevSlide()"
        aria-label="Previous slide"
      >
        <span class="icon-chevron" aria-hidden="true">‚Äπ</span>
      </button>
      <button
        class="carousel-btn next"
        type="button"
        (click)="nextSlide()"
        aria-label="Next slide"
      >
        <span class="icon-chevron" aria-hidden="true">‚Ä∫</span>
      </button>

      <!-- Dots -->
      <div class="carousel-dots" role="tablist" aria-label="Slide buttons">
        <button
          *ngFor="let i of [0, 1, 2, 3]"
          class="dot"
          role="tab"
          type="button"
          [class.active]="currentSlide === i"
          [attr.aria-selected]="currentSlide === i"
          [attr.aria-label]="'Go to slide ' + (i + 1)"
          (click)="goToSlide(i)"
        ></button>
      </div>
    </section>

    <!-- RANDOM (1/3) ‚Äì LCP -->
    <!-- RANDOM (1/3) ‚Äì LCP -->
    @defer (on viewport; prefetch on idle) { @if (randomCocktail) {
    <section
      class="random-cocktail-section"
      role="region"
      aria-label="Fizzando‚Äôs Cocktail of the Day"
      (mouseenter)="burstConfetti()"
      (focusin)="burstConfetti()"
    >
      <div
        class="cocktail-display glass-card"
        #cotdBox
        (mouseenter)="burstConfetti()"
        (focusin)="burstConfetti()"
      >
        <h3 id="cotd-heading">Fizzando‚Äôs Cocktail of the Day</h3>

        @defer (on viewport; prefetch on idle) {
        <app-confetti-burst
          #confetti
          [triggerOnInit]="false"
          [particleCount]="200"
          [duration]="2400"
          [maxDpr]="2"
          [highDprParticleScale]="0.7"
          [reducedMotionParticleScale]="0.5"
          [minParticleCount]="60"
          [restartIfRunning]="false"
          [cooldownMs]="700"
          aria-hidden="true"
          role="presentation"
        ></app-confetti-burst>
        } @placeholder {
        <span aria-hidden="true"></span>
        }

        <img
          [ngSrc]="getBestImageUrl(randomCocktail.image, 360)"
          [attr.srcset]="getCotdSrcSet(randomCocktail.image)"
          [alt]="
            randomCocktail.name
              ? 'Photo of ' +
                randomCocktail.name +
                ', Fizzando‚Äôs Cocktail of the Day'
              : 'Random cocktail photo'
          "
          width="210"
          height="210"
          decoding="async"
          class="random-cocktail-image"
          priority
          sizes="(min-width: 641px) 33vw, 70vw"
          [disableOptimizedSrcset]="true"
        />

        <div class="content-random">
          <h4 id="cotd-name">{{ randomCocktail.name }}</h4>

          <button
            class="btn-shine hover-move"
            type="button"
            (click)="
              celebrateAndGo($event, ['/cocktails', randomCocktail.slug])
            "
            [attr.aria-label]="
              'View recipe for ' +
              randomCocktail.name +
              ', Fizzando‚Äôs Cocktail of the Day'
            "
          >
            <span aria-hidden="true">üç∏</span>
            <span>View Recipe</span>
          </button>
        </div>

        <p class="random-cta">
          <a
            [routerLink]="['/cocktails', randomCocktail.slug]"
            [attr.aria-label]="
              'Open ' +
              randomCocktail.name +
              ' ‚Äî details page of Fizzando‚Äôs Cocktail of the Day'
            "
          >
            View the cocktail
          </a>
        </p>
      </div>

      <div class="glass-card cocktail-display-button">
        <h3>Quick links</h3>
        <div class="quick-link-home">
          <fizz-button [routerLink]="['/cocktails']" [responsive]="true"
            >All Cocktails</fizz-button
          >
          <fizz-button [routerLink]="['/ingredients']" [responsive]="true"
            >All Ingredients</fizz-button
          >
          <fizz-button [routerLink]="['/ingredients']" [responsive]="true"
            >Generate cocktail</fizz-button
          >
          <fizz-button [routerLink]="['/ingredients']" [responsive]="true"
            >Glossary</fizz-button
          >
        </div>
      </div>
    </section>

    } @else {
    <!-- Questo non √® un placeholder del defer: √® l'ELSE del tuo @if -->
    <section
      class="ad-block"
      role="complementary"
      aria-label="Sponsored content"
    >
      <span class="ad-badge">Ad</span>
      <app-dev-ads
        [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
      ></app-dev-ads>
    </section>
    } } @placeholder {
    <!-- Questo √® l'UNICO placeholder del DEFER esterno -->
    <section class="random-cocktail-section placeholder" aria-hidden="true">
      <div class="cocktail-display glass-card skeleton"></div>
    </section>
    }

    <ng-container *ngIf="contentReady">
      @defer (on viewport) {
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      } @placeholder {
      <!-- Placeholder identico per evitare qualsiasi shift -->
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
        aria-hidden="true"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      }
    </ng-container>

    <!-- ===================== AD #1 (defer + SSR-safe) ===================== -->

    <!-- FEATURED COCKTAILS -->
    @defer (on viewport) {
    <section
      class="section-block glass-card dark"
      *ngIf="featuredCocktails.length"
    >
      <div class="section-head">
        <h3>Featured Cocktails</h3>
        <a class="link-inline" [routerLink]="['/cocktails']">View all</a>
      </div>
      <div class="cards-grid limit-4">
        <app-cocktail-card
          *ngFor="
            let c of featuredCocktails | slice : 0 : 8;
            let i = index;
            trackBy: trackByCocktail
          "
          [cocktail]="c"
          [isLcp]="false"
        ></app-cocktail-card>
      </div>
    </section>
    } @placeholder {
    <section class="section-block glass-card" aria-hidden="true">
      <div class="cards-grid limit-4">
        <div class="skeleton-card" *ngFor="let _ of [1, 2, 3, 4]"></div>
      </div>
    </section>
    }
    <!-- ===================== AD #2 (defer + SSR-safe) ===================== -->
    <ng-container *ngIf="contentReady">
      @defer (on viewport) {
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      } @placeholder {
      <!-- Placeholder identico per evitare qualsiasi shift -->
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
        aria-hidden="true"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      }
    </ng-container>

    <!-- LATEST INGREDIENTS (defer: viewport) -->
    @defer (on viewport) {
    <section
      class="section-block glass-card dark"
      *ngIf="latestIngredients.length"
    >
      <div class="section-head">
        <h3>Latest Ingredients</h3>
        <a class="link-inline" [routerLink]="['/ingredients']">View all</a>
      </div>
      <div class="cards-grid limit-4">
        <app-ingredient-card
          *ngFor="let ing of latestIngredients; trackBy: trackByIngredient"
          [ingredient]="ing"
        ></app-ingredient-card>
      </div>
    </section>
    } @placeholder {
    <section
      class="section-block glass-card skeleton"
      aria-hidden="true"
    ></section>
    }

    <!-- QUICK LINKS -->
    <section class="quick-links-section glass-card">
      <div class="section-head">
        <h3>Quick Explore</h3>
      </div>

      <div class="links-grid">
        <button class="glass-button secondary" [routerLink]="['/cocktails']">
          <span class="icon-inline" aria-hidden="true">üç∏</span> All Cocktails
        </button>
        <button class="glass-button secondary" [routerLink]="['/ingredients']">
          <span class="icon-inline" aria-hidden="true">üß™</span> All Ingredients
        </button>
        <button
          class="glass-button secondary"
          [routerLink]="['/find-cocktail']"
        >
          <span class="icon-inline" aria-hidden="true">üîç</span> Find by
          Ingredients
        </button>
        <button
          class="glass-button secondary"
          [routerLink]="['/cocktails']"
          [queryParams]="{ alcoholic: 'Alcoholic' }"
        >
          <span class="icon-inline" aria-hidden="true">ü•É</span> Alcoholic
        </button>
        <button
          class="glass-button secondary"
          [routerLink]="['/cocktails']"
          [queryParams]="{ alcoholic: 'Non Alcoholic' }"
        >
          <span class="icon-inline" aria-hidden="true">üçπ</span> Non-Alcoholic
        </button>
      </div>

      <div class="cocktail-chips" *ngIf="topCocktailCategories.length">
        <span class="chip-label">Popular categories:</span>
        <a
          class="chip"
          *ngFor="let cat of topCocktailCategories; trackBy: trackByString"
          [routerLink]="['/cocktails']"
          [queryParams]="{ search: cat }"
        >
          {{ cat }}
        </a>
      </div>
    </section>

    <!-- GLOSSARY (random 4) -->
    <section
      class="section-block glass-card"
      *ngIf="randomGlossaryTerms.length"
    >
      <div class="section-head">
        <h3>Discover Glossary Terms</h3>
        <a class="link-inline" [routerLink]="['/glossary']">View all</a>
      </div>
      <div class="cards-grid limit-4">
        <app-glossary-card
          *ngFor="let t of randomGlossaryTerms; trackBy: trackByGlossary"
          [term]="t"
        ></app-glossary-card>
      </div>
    </section>

    <!-- ===================== AD #4 (defer + SSR-safe) ===================== -->
    <ng-container *ngIf="contentReady">
      @defer (on viewport) {
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      } @placeholder {
      <!-- Placeholder identico per evitare qualsiasi shift -->
      <section
        class="ad-block"
        role="complementary"
        aria-label="Sponsored content"
        aria-hidden="true"
      >
        <span class="ad-badge">Ad</span>
        <app-dev-ads
          [type]="isMobile ? 'mobile-banner' : 'leaderboard'"
        ></app-dev-ads>
      </section>
      }
    </ng-container>
  </div>
</div>
