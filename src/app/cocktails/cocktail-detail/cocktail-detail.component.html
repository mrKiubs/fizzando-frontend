<main class="cocktail-detail-wrapper" role="main">
  <!-- Loading / Error -->
  <div *ngIf="loading" class="loading-message glass-card" role="status">
    <p>Loading cocktail details...</p>
  </div>

  <div *ngIf="error" class="error-message glass-card" role="alert">
    <mat-icon aria-hidden="true">error</mat-icon>
    <span>{{ error }}</span>
    <button
      class="glass-button secondary"
      (click)="goBack()"
      aria-label="Go back to previous page"
    >
      <mat-icon aria-hidden="true">arrow_back</mat-icon>
      <span>Go Back</span>
    </button>
  </div>

  <!-- Title / Subtitle -->
  <ng-container *ngIf="cocktail && !loading && !error">
    <header
      class="cocktail-detail-header"
      role="banner"
      aria-labelledby="cocktail-title"
      aria-describedby="cocktail-summary"
    >
      <!-- Titolo principale, semantico -->
      <h1 id="cocktail-title" class="cocktail-title">
        {{ cocktail.name }} —
        <span class="visually-hidden">Cocktail recipe details</span>
      </h1>

      <!-- Sottotitolo descrittivo -->
      <h2
        id="cocktail-summary"
        class="cocktail-subtitle"
        aria-label="Cocktail summary and classification"
      >
        <span class="row">
          <span class="category" aria-label="Category">
            Category: {{ cocktail.category }}
          </span>
          <span class="separator" aria-hidden="true">|</span>
          <span class="alcoholic" aria-label="Alcohol profile">
            {{ cocktail.alcoholic }}
          </span>
        </span>

        <span class="row">
          <span class="method" aria-label="Preparation method">
            Method: {{ cocktail.preparation_type }}
          </span>
          <span class="separator" aria-hidden="true">|</span>
          <span class="glass" aria-label="Served in glass type">
            Glass: {{ cocktail.glass }}
          </span>
        </span>
      </h2>
    </header>
  </ng-container>

  <!-- Main card -->
  <article
    *ngIf="cocktail && !loading && !error"
    class="cocktail-main-content glass-card"
    aria-labelledby="cocktail-title"
  >
    <div class="main-content-grid">
      <!-- Image -->
      <div class="cocktail-image-column" role="figure">
        <div class="image-wrapper">
          <img
            class="detail-image"
            [ngSrc]="heroSrc || getPreferred(getCocktailHeroUrl(cocktail))"
            [attr.srcset]="
              heroSrcset || getCocktailImageSrcsetPreferred(cocktail)
            "
            sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw"
            width="500"
            height="500"
            priority
            [disableOptimizedSrcset]="true"
            [alt]="
              cocktail.name
                ? 'Photo of ' + cocktail.name + ' cocktail'
                : 'Cocktail photo'
            "
            (error)="
              onImgErrorWithSrcset(
                $event,
                getCocktailHeroUrl(cocktail),
                getCocktailImageSrcset(cocktail)
              )
            "
          />
        </div>
      </div>

      <!-- Description + Instructions -->
      <div class="cocktail-description-instructions-column">
        <section
          class="description-section"
          role="region"
          attr.aria-labelledby="desc-{{ cocktail.slug }}"
          attr.aria-describedby="desc-summary-{{ cocktail.slug }}"
        >
          <h2 id="desc-{{ cocktail.slug }}" class="section-title sr-only">
            Description of {{ cocktail.name }}
          </h2>
          <p
            id="desc-summary-{{ cocktail.slug }}"
            [sentenceBreaks]="cocktail.ai_description"
          ></p>
        </section>

        <section
          class="instructions-section"
          role="region"
          attr.aria-labelledby="instr-{{ cocktail.slug }}"
        >
          <h2 id="instr-{{ cocktail.slug }}" class="section-title">
            <span aria-hidden="true">🧾</span> Instructions to prepare
            {{ cocktail.name }}
          </h2>
          <p [sentenceBreaks]="cocktail.instructions"></p>
        </section>
      </div>

      <!-- Ingredients -->
      <div class="cocktail-ingredients-column">
        <section
          class="ingredients-section"
          role="region"
          attr.aria-labelledby="ingredients-{{ cocktail.slug }}"
        >
          <h2 id="ingredients-{{ cocktail.slug }}" class="section-title">
            <span aria-hidden="true">🥄</span> Ingredients for
            {{ cocktail.name }}
          </h2>
          <ul class="ingredient-list" role="list">
            <li *ngFor="let item of cocktail.ingredients_list" role="listitem">
              <a
                [routerLink]="['/ingredients', item.ingredient.external_id]"
                [attr.href]="'/ingredients/' + item.ingredient.external_id"
                class="ingredient-link"
                [attr.aria-label]="
                  'Ingredient of ' +
                  cocktail.name +
                  ': ' +
                  item.ingredient.name +
                  (item.measure ? ', measure ' + item.measure : '')
                "
              >
                <div class="image-ingredient-wrapper">
                  <img
                    [ngSrc]="getPreferred(getIngredientImageUrl(item))"
                    [alt]="'Photo of ' + item.ingredient.name + ' ingredient'"
                    width="50"
                    height="50"
                    loading="lazy"
                    decoding="async"
                    [attr.fetchpriority]="'low'"
                    (error)="onImgError($event, getIngredientImageUrl(item))"
                  />
                </div>

                <span class="ingredient-measure">{{ item.measure }}</span>

                <div class="ing-cocktail">
                  {{ item.ingredient.name }}
                  <span class="ing-type">{{
                    item.ingredient.ingredient_type
                  }}</span>
                </div>
              </a>
            </li>
          </ul>
        </section>
      </div>
    </div>
  </article>

  <!-- AD BLOCK #1 -->
  <section
    class="ad-block"
    [ngClass]="adSlotClass(getTopAdType())"
    role="complementary"
    aria-labelledby="ad-label-top"
  >
    <span id="ad-label-top" class="ad-badge">Ad</span>

    @defer (when contentReady; on viewport) {
    <div class="ad-slot-inner">
      <app-dev-ads [type]="getTopAdType()"></app-dev-ads>
    </div>
    } @placeholder {
    <div class="ad-slot-placeholder" aria-hidden="true"></div>
    }
  </section>

  <!-- Deep Dive -->
  <section
    *ngIf="cocktail && !loading && !error"
    class="ai-details-section glass-card"
    role="region"
    [attr.aria-labelledby]="'deepdive-' + cocktail.slug"
  >
    <h2 id="deepdive-{{ cocktail.slug }}" class="section-title">
      <span aria-hidden="true">✨</span> {{ cocktail.name }} Deep Dive — AI
      insights
    </h2>

    <div class="ai-blocks-grid">
      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_presentation"
        role="group"
      >
        <h3 class="ai-block-title">🎁 Presentation</h3>
        <p>{{ cocktail.ai_presentation }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_pairing"
        role="group"
      >
        <h3 class="ai-block-title">🍽️ Pairing</h3>
        <p>{{ cocktail.ai_pairing }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_origin"
        role="group"
      >
        <h3 class="ai-block-title">🌍 Origin</h3>
        <p>{{ cocktail.ai_origin }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_occasion"
        role="group"
      >
        <h3 class="ai-block-title">🎉 Occasion</h3>
        <p>{{ cocktail.ai_occasion }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_sensory_description"
        role="group"
      >
        <h3 class="ai-block-title">👃 Sensory Description</h3>
        <p>{{ cocktail.ai_sensory_description }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_personality"
        role="group"
      >
        <h3 class="ai-block-title">😎 Personality</h3>
        <p>{{ cocktail.ai_personality }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_variations"
        role="group"
      >
        <h3 class="ai-block-title">🔄 Variations</h3>
        <p>{{ cocktail.ai_variations }}</p>
      </div>

      <div
        class="ai-detail-block glass-card-mini"
        *ngIf="cocktail.ai_alcohol_content"
        role="group"
      >
        <h3 class="ai-block-title">🍸 Alcohol Content</h3>
        <p>{{ cocktail.ai_alcohol_content }}</p>

        <p class="abv-warning" style="margin-top: 8px">
          <ng-container
            *ngIf="cocktail.alcoholic === 'Alcoholic'; else noLimitDesktop"
          >
            🚫 Not for minors, pregnant mamas or designated drivers—sip
            responsibly! 😉
          </ng-container>
          <ng-template #noLimitDesktop
            >🆓 No booze here—drink up, the world is your oyster!
            🍹</ng-template
          >
        </p>
      </div>
    </div>
  </section>

  <!-- Related Articles -->
  <section
    class="related-articles-section"
    *ngIf="relatedArticles.length > 0"
    role="region"
    [attr.aria-labelledby]="'articles-' + cocktail?.slug"
  >
    <h2 id="articles-{{ cocktail?.slug }}" class="section-title">
      <span aria-hidden="true">📰</span> More about {{ cocktail?.name }} —
      related articles
    </h2>
    <div class="related-articles-grid">
      <ng-container *ngFor="let a of relatedArticles">
        <app-article-card [article]="a"></app-article-card>
      </ng-container>
    </div>
  </section>

  <!-- AD BLOCK #2 -->
  <section
    class="ad-block"
    [ngClass]="adSlotClass(getTopAdType())"
    role="complementary"
    aria-labelledby="ad-label-top"
  >
    <span id="ad-label-top" class="ad-badge">Ad</span>

    @defer (when contentReady; on viewport) {
    <div class="ad-slot-inner">
      <app-dev-ads [type]="getTopAdType()"></app-dev-ads>
    </div>
    } @placeholder {
    <div class="ad-slot-placeholder" aria-hidden="true"></div>
    }
  </section>

  <!-- Related Cocktails -->
  <section
    class="related-cocktails-section"
    *ngIf="relatedWithAds.length > 0"
    role="region"
    [attr.aria-labelledby]="'related-' + cocktail?.slug"
  >
    <h2 id="related-{{ cocktail?.slug }}" class="section-title">
      <span aria-hidden="true">✨</span>
      If you liked the {{ cocktail?.name }}, try these related cocktails
    </h2>

    <div class="cards-grid limit-4">
      <ng-container *ngFor="let item of relatedWithAds; let i = index">
        <ng-container *ngIf="!$any(item).isAd; else adTpl">
          <app-cocktail-card
            ngSkipHydration
            [cocktail]="$any(item)"
            [showCorrelation]="true"
            [routerLink]="['/cocktails', $any(item)?.slug]"
          ></app-cocktail-card>
        </ng-container>

        <ng-template #adTpl>
          <section
            class="ad-block"
            role="complementary"
            aria-labelledby="'ad-label-loop-' + i"
          >
            <span
              [attr.id]="'ad-label-loop-' + i"
              class="ad-badge"
              aria-hidden="false"
              >Ad</span
            >
            <div [class]="adSlotClass(getLoopAdType())">
              <app-dev-ads [type]="getLoopAdType()"></app-dev-ads>
            </div>
          </section>
        </ng-template>
      </ng-container>
    </div>
  </section>

  <!-- Bottom Ad -->
  <section
    class="ad-block"
    [ngClass]="adSlotClass(getTopAdType())"
    role="complementary"
    aria-labelledby="ad-label-bottom"
  >
    <span id="ad-label-bottom" class="ad-badge">Ad</span>
    @defer (when contentReady; on viewport) {
    <div class="ad-slot-inner">
      <app-dev-ads [type]="getTopAdType()"></app-dev-ads>
    </div>
    } @placeholder {
    <div class="ad-slot-placeholder" aria-hidden="true"></div>
    }
  </section>

  <!-- Navigation -->
  <nav
    class="navigation-bar"
    *ngIf="
      !loading && !error && (indexReady || previousCocktail || nextCocktail)
    "
    aria-label="Cocktail navigation"
  >
    <div class="nav-top">
      <a
        *ngIf="previousCocktail"
        [routerLink]="['/cocktails', previousCocktail.slug]"
        class="glass-button secondary nav-button"
        [attr.aria-label]="
          'Previous cocktail: ' + (previousCocktail.name || '')
        "
      >
        <mat-icon svgIcon="chevron_left" aria-hidden="true"></mat-icon>
        <div class="cocktail-image-wrapper" aria-hidden="true">
          <img
            [ngSrc]="previousCocktail.imageUrl"
            alt=""
            class="nav-cocktail-image"
            width="36"
            height="36"
            loading="lazy"
            decoding="async"
          />
        </div>
        {{ previousCocktail.name }}
      </a>

      <a
        *ngIf="nextCocktail"
        [routerLink]="['/cocktails', nextCocktail.slug]"
        class="glass-button secondary nav-button"
        [attr.aria-label]="'Next cocktail: ' + (nextCocktail.name || '')"
      >
        {{ nextCocktail.name }}
        <div class="cocktail-image-wrapper" aria-hidden="true">
          <img
            [ngSrc]="nextCocktail.imageUrl"
            alt=""
            class="nav-cocktail-image"
            width="36"
            height="36"
            loading="lazy"
            decoding="async"
          />
        </div>
        <mat-icon svgIcon="chevron_right" aria-hidden="true"></mat-icon>
      </a>
    </div>

    <div class="nav-bottom">
      <button
        class="glass-button secondary"
        (click)="goBack()"
        aria-label="Go back to cocktail list"
      >
        <mat-icon svgIcon="arrow_back" aria-hidden="true"></mat-icon>
        <span>Go Back</span>
      </button>
    </div>
  </nav>
</main>
